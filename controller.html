<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pulse Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      background: radial-gradient(circle at top, #111827, #020617);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .app {
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      padding:20px 18px 18px;
      box-shadow:0 18px 45px rgba(0,0,0,0.65);
      border:1px solid rgba(148,163,184,0.25);
    }
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .title {
      font-size:1.1rem;
      font-weight:600;
      letter-spacing:.04em;
    }
    .state-chip {
      font-size:0.75rem;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(59,130,246,0.12);
      color:#93c5fd;
      border:1px solid rgba(147,197,253,0.5);
    }
    .content {
      display:flex;
      gap:16px;
    }
    .left, .right { flex:1; }

    .slider-wrap {
      height:260px;
      background:radial-gradient(circle at top,#020617,#020617);
      border-radius:16px;
      border:1px solid rgba(55,65,81,0.9);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:12px 4px;
    }

    .slider-label {
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#9ca3af;
      margin-bottom:8px;
    }

    .vertical-slider {
      writing-mode: bt-lr;
      -webkit-appearance: slider-vertical;
      width: 36px;
      height: 170px;
      padding: 0;
      border-radius:999px;
      background: transparent;
    }

    input[type=range] {
      accent-color:#22c55e;
    }

    .level-display {
      margin-top:10px;
      font-size:0.9rem;
      color:#e5e7eb;
    }

    .timer-card {
      background:rgba(15,23,42,0.9);
      border-radius:14px;
      padding:12px 12px 10px;
      border:1px solid rgba(55,65,81,0.9);
      margin-bottom:10px;
    }
    .timer-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#9ca3af;
    }
    .countdown {
      font-size:1.8rem;
      font-weight:600;
    }
    .session-name {
      font-size:0.75rem;
      color:#9ca3af;
      margin-top:3px;
    }
    .sessions-list {
      max-height:160px;
      overflow-y:auto;
      margin-top:6px;
    }
    .session-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 9px;
      margin-bottom:6px;
      border-radius:10px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(55,65,81,0.9);
      font-size:0.78rem;
      cursor:pointer;
      transition:background .15s ease,border-color .15s ease,transform .05s ease;
    }
    .session-item:hover {
      background:rgba(24,33,57,1);
      border-color:#22c55e;
      transform:translateY(-1px);
    }
    .session-item.active {
      border-color:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.6);
    }
    .session-item .name {
      font-weight:500;
      color:#e5e7eb;
    }
    .session-item .meta {
      color:#9ca3af;
      display:flex;
      gap:10px;
    }
    .session-item .dot {
      width:8px;
      height:8px;
      border-radius:999px;
      margin-right:4px;
    }
    .dot.active { background:#22c55e; box-shadow:0 0 6px #22c55e; }
    .dot.pending { background:#eab308; }
    .dot.finished { background:#6b7280; }

    .primary-btn, .ghost-btn {
      border-radius:999px;
      border:none;
      padding:7px 14px;
      font-size:0.8rem;
      cursor:pointer;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:5px;
      white-space:nowrap;
    }
    .primary-btn {
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#ecfdf5;
    }
    .primary-btn:disabled {
      opacity:0.35;
      cursor:default;
    }
    .ghost-btn {
      background:transparent;
      border:1px solid rgba(75,85,99,0.9);
      color:#9ca3af;
    }
    .footer-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:0.75rem;
      color:#6b7280;
    }
  </style>

  <!-- Firebase compat SDK [web:1][web:6][web:9][web:18] -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">Lush Pulse • Controller</div>
      <div class="state-chip" id="controllerState">Idle</div>
    </div>

    <div class="content">
      <div class="left">
        <div class="slider-wrap">
          <div class="slider-label">Pulse Strength</div>
          <input
            id="pulseSlider"
            type="range"
            min="0"
            max="10"
            step="1"
            value="0"
            class="vertical-slider"
          />
          <div class="level-display">Level: <span id="sliderLevel">0</span>/10</div>
        </div>
      </div>

      <div class="right">
        <div class="timer-card">
          <div class="timer-top">
            <span>Session Timer</span>
            <button id="stopSessionBtn" class="ghost-btn">Stop</button>
          </div>
          <div class="countdown" id="countdown">00:00</div>
          <div class="session-name" id="currentSessionName">No active session</div>
        </div>

        <div class="timer-card">
          <div class="timer-top">
            <span>Available Sessions</span>
            <button id="refreshBtn" class="ghost-btn">Refresh</button>
          </div>
          <div class="sessions-list" id="sessionsList"></div>
          <div class="footer-row">
            <span>Tap a session to start.</span>
            <button id="startSessionBtn" class="primary-btn" disabled>Start</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // TODO: same Firebase config as receiver.html [web:1][web:12]
    const firebaseConfig = {
    apiKey: "AIzaSyCSQRo8ee2Dj26J0PQyQsosLfkNDw4Lni0",
    authDomain: "testapp-9b43c.firebaseapp.com",
    databaseURL: "https://testapp-9b43c-default-rtdb.firebaseio.com",
    projectId: "testapp-9b43c",
    storageBucket: "testapp-9b43c.firebasestorage.app",
    messagingSenderId: "475089690708",
    appId: "1:475089690708:web:f86d7436dfa74a96134dc1",
    measurementId: "G-FZCZQGZD5Y"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const pulseRef = db.ref("device/pulseLevel");
    const sessionRef = db.ref("device/session");
    const sessionsRef = db.ref("device/sessions");

    const slider = document.getElementById("pulseSlider");
    const sliderLevelEl = document.getElementById("sliderLevel");
    const controllerStateEl = document.getElementById("controllerState");
    const countdownEl = document.getElementById("countdown");
    const currentSessionNameEl = document.getElementById("currentSessionName");
    const sessionsListEl = document.getElementById("sessionsList");
    const startSessionBtn = document.getElementById("startSessionBtn");
    const stopSessionBtn = document.getElementById("stopSessionBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    let sessionsCache = {};
    let selectedSessionId = null;
    let activeSessionId = null;
    let localRemaining = 0;
    let tickInterval = null;

    slider.addEventListener("input", () => {
      const value = Number(slider.value);
      sliderLevelEl.textContent = value;
      if (controllerStateEl.textContent.toLowerCase() === "running") {
        pulseRef.set(value);
      } else {
        pulseRef.set(0);
      }
    });

    function renderSessions() {
      sessionsListEl.innerHTML = "";
      Object.keys(sessionsCache).forEach((key) => {
        const s = sessionsCache[key];
        const item = document.createElement("div");
        item.className = "session-item";
        if (key === selectedSessionId) item.classList.add("active");

        const statusDotClass =
          s.state === "active" ? "dot active" :
          s.state === "finished" ? "dot finished" : "dot pending";

        item.innerHTML = `
          <div>
            <div class="name">${s.name || "Session"}</div>
            <div style="display:flex;align-items:center;margin-top:2px;font-size:0.72rem;color:#9ca3af;">
              <div class="${statusDotClass} dot"></div>
              <span>${s.state || "pending"}</span>
            </div>
          </div>
          <div class="meta">
            <span>${s.minutes || 0} min</span>
          </div>
        `;
        item.addEventListener("click", () => {
          selectedSessionId = key;
          renderSessions();
          startSessionBtn.disabled = false;
        });
        sessionsListEl.appendChild(item);
      });
    }

    sessionsRef.on("value", (snap) => {
      sessionsCache = snap.val() || {};
      renderSessions();
    });

    sessionRef.on("value", (snap) => {
      const data = snap.val();
      if (!data) {
        controllerStateEl.textContent = "Idle";
        countdownEl.textContent = "00:00";
        currentSessionNameEl.textContent = "No active session";
        activeSessionId = null;
        localRemaining = 0;
        slider.disabled = true;
        startSessionBtn.disabled = !selectedSessionId;
        pulseRef.set(0);
        if (tickInterval) {
          clearInterval(tickInterval);
          tickInterval = null;
        }
        return;
      }

      controllerStateEl.textContent = data.state === "running" ? "Running" : data.state ?? "Idle";
      activeSessionId = data.id || null;
      currentSessionNameEl.textContent = data.name ? ("Active • " + data.name) : "Active session";
      localRemaining = data.remainingSeconds ?? 0;
      updateCountdownText(localRemaining);

      slider.disabled = data.state !== "running";

      if (!tickInterval) {
        tickInterval = setInterval(() => {
          if (localRemaining > 0 && controllerStateEl.textContent.toLowerCase() === "running") {
            localRemaining--;
            updateCountdownText(localRemaining);
          } else if (localRemaining <= 0 && controllerStateEl.textContent.toLowerCase() === "running") {
            endSession();
          }
        }, 1000);
      }
    });

    function updateCountdownText(sec) {
      const r = Math.max(0, sec);
      const m = String(Math.floor(r / 60)).padStart(2, "0");
      const s = String(r % 60).padStart(2, "0");
      countdownEl.textContent = m + ":" + s;
    }

    async function startSession() {
      if (!selectedSessionId || !sessionsCache[selectedSessionId]) return;
      const s = sessionsCache[selectedSessionId];
      const totalSeconds = (s.minutes || 0) * 60;
      if (!totalSeconds) return;

      const update = {
        id: selectedSessionId,
        name: s.name || "Session",
        minutes: s.minutes || 0,
        state: "running",
        totalSeconds,
        remainingSeconds: totalSeconds,
        startedAt: Date.now()
      };
      await sessionRef.set(update);
      await sessionsRef.child(selectedSessionId).update({ state: "active" });
      controllerStateEl.textContent = "Running";
      slider.disabled = false;
      pulseRef.set(Number(slider.value));
    }

    async function endSession() {
      controllerStateEl.textContent = "Finished";
      slider.disabled = true;
      pulseRef.set(0);

      if (activeSessionId) {
        await sessionsRef.child(activeSessionId).update({ state: "finished" });
      }
      await sessionRef.set(null);
    }

    startSessionBtn.addEventListener("click", () => {
      startSession();
    });

    stopSessionBtn.addEventListener("click", () => {
      endSession();
    });

    refreshBtn.addEventListener("click", () => {
      sessionsRef.once("value").then((snap) => {
        sessionsCache = snap.val() || {};
        renderSessions();
      });
    });
  </script>
</body>
</html>
