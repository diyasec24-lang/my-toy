<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pulse Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body {
      background: radial-gradient(circle at top,#111827,#020617);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .app {
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      padding:20px 18px 18px;
      box-shadow:0 18px 45px rgba(0,0,0,0.65);
      border:1px solid rgba(148,163,184,0.25);
    }
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .title { font-size:1.1rem; font-weight:600; letter-spacing:.04em; }
    .state-chip {
      font-size:0.75rem;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(59,130,246,0.12);
      color:#93c5fd;
      border:1px solid rgba(147,197,253,0.5);
    }

    .row { display:flex; gap:16px; }

    .slider-card {
      flex:1;
      height:260px;
      border-radius:16px;
      border:1px solid rgba(55,65,81,0.9);
      background:radial-gradient(circle at top,#020617,#020617);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:12px 4px;
    }
    .slider-label {
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#9ca3af;
      margin-bottom:10px;
    }

    /* سلايدر عمودي حقيقي [web:21][web:24] */
    #pulseSlider {
      -webkit-appearance: slider-vertical;
      writing-mode: bt-lr;
      width:36px;
      height:170px;
      background:transparent;
      padding:0;
    }
    #pulseSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width:18px;
      height:18px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 10px rgba(34,197,94,0.9);
    }
    #pulseSlider::-webkit-slider-runnable-track {
      background:linear-gradient(#22c55e,#eab308,#ef4444);
      border-radius:999px;
    }
    input[type=range] { accent-color:#22c55e; }

    .level-display { margin-top:10px; font-size:0.9rem; }

    .card {
      flex:1;
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.9);
      margin-bottom:10px;
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#9ca3af;
      margin-bottom:8px;
    }
    .countdown {
      font-size:1.8rem;
      font-weight:600;
    }
    .session-meta {
      font-size:0.75rem;
      color:#9ca3af;
      margin-top:4px;
    }
    .field-row {
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    input, button {
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:rgba(15,23,42,0.9);
      color:#f9fafb;
      font-size:0.8rem;
      padding:7px 10px;
    }
    input:focus, button:focus {
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,0.35);
    }
    button {
      cursor:pointer;
      border:none;
      white-space:nowrap;
    }
    .primary-btn {
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none;
      font-weight:500;
      color:#ecfdf5;
    }
    .primary-btn:disabled { opacity:.35; cursor:default; }
    .ghost-btn {
      background:transparent;
      border:1px solid rgba(75,85,99,0.9);
      color:#9ca3af;
    }
    .hint { font-size:0.72rem; color:#6b7280; margin-top:4px; }
  </style>

  <!-- Firebase compat SDK [web:2] -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">Lush Pulse • Controller</div>
      <div class="state-chip" id="controllerState">Idle</div>
    </div>

    <div class="row">
      <div class="slider-card">
        <div class="slider-label">Pulse Strength</div>
        <input id="pulseSlider" type="range" min="0" max="10" step="1" value="0" />
        <div class="level-display">Level: <span id="sliderLevel">0</span>/10</div>
      </div>

      <div style="flex:1;display:flex;flex-direction:column;gap:10px;">
        <div class="card">
          <div class="card-header">
            <span>Session Timer</span>
            <button id="stopBtn" class="ghost-btn">Stop</button>
          </div>
          <div class="countdown" id="countdown">00:00</div>
          <div class="session-meta" id="sessionInfo">No active session</div>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Attach Session</span>
          </div>
          <div class="field-row">
            <input id="sessionIdInput" type="text" placeholder="Enter session ID" />
            <button id="attachBtn" class="primary-btn">Attach</button>
          </div>
          <div class="hint">
            Session ID comes from receiver page when a new session is created.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ضع نفس الإعدادات في الصفحتين [web:2]
    const firebaseConfig = {
    apiKey: "AIzaSyCSQRo8ee2Dj26J0PQyQsosLfkNDw4Lni0",
    authDomain: "testapp-9b43c.firebaseapp.com",
    databaseURL: "https://testapp-9b43c-default-rtdb.firebaseio.com",
    projectId: "testapp-9b43c",
    storageBucket: "testapp-9b43c.firebasestorage.app",
    messagingSenderId: "475089690708",
    appId: "1:475089690708:web:f86d7436dfa74a96134dc1",
    measurementId: "G-FZCZQGZD5Y"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const pulseRef          = db.ref("device/pulseLevel");
    const activeSessionRef  = db.ref("device/activeSession");
    const sessionsRef       = db.ref("sessions");

    const slider            = document.getElementById("pulseSlider");
    const sliderLevelEl     = document.getElementById("sliderLevel");
    const controllerStateEl = document.getElementById("controllerState");
    const countdownEl       = document.getElementById("countdown");
    const sessionInfoEl     = document.getElementById("sessionInfo");
    const sessionIdInput    = document.getElementById("sessionIdInput");
    const attachBtn         = document.getElementById("attachBtn");
    const stopBtn           = document.getElementById("stopBtn");

    let active = null;        // كائن الجلسة الفعالة
    let tickInterval = null;
    let lockedSessionIds = new Set(); // جلسات انتهت ولا يسمح بإعادة تشغيلها

    slider.disabled = true;   // مغلق حتى يتم إرفاق جلسة

    slider.addEventListener("input", () => {
      const value = Number(slider.value);
      sliderLevelEl.textContent = value;
      if (active && active.state === "running") {
        pulseRef.set(value);
      } else {
        pulseRef.set(0);
      }
    });

    function updateCountdownText(sec) {
      const r = Math.max(0, sec);
      const m = String(Math.floor(r / 60)).padStart(2, "0");
      const s = String(r % 60).padStart(2, "0");
      countdownEl.textContent = m + ":" + s;
    }

    // مراقبة الجلسة النشطة من Firebase
    activeSessionRef.on("value", (snap) => {
      const data = snap.val();
      active = data;

      if (!data) {
        controllerStateEl.textContent = "Idle";
        sessionInfoEl.textContent = "No active session";
        updateCountdownText(0);
        slider.disabled = true;
        pulseRef.set(0);
        if (tickInterval) { clearInterval(tickInterval); tickInterval = null; }
        return;
      }

      updateCountdownText(data.remainingSeconds ?? 0);
      sessionInfoEl.textContent = `Session: ${data.name || data.id} • ID: ${data.id}`;
      slider.disabled = data.state === "running" && !lockedSessionIds.has(data.id);
      controllerStateEl.textContent = data.state === "running" ? "Running" : data.state;

      if (tickInterval) { clearInterval(tickInterval); }
      tickInterval = setInterval(() => {
        if (!active || active.state !== "running") return;
        if (active.remainingSeconds <= 0) {
          endSession();
        } else {
          active.remainingSeconds -= 1;
          updateCountdownText(active.remainingSeconds);
        }
      }, 1000);
    });

    // إرفاق جلسة عن طريق ID
    attachBtn.addEventListener("click", async () => {
      const id = sessionIdInput.value.trim();
      if (!id || lockedSessionIds.has(id)) return;

      const snap = await sessionsRef.child(id).get();
      if (!snap.exists()) {
        alert("Session not found or already finished.");
        return;
      }
      const session = snap.val();
      if (session.state === "finished") {
        lockedSessionIds.add(id);
        alert("This session is already finished.");
        return;
      }

      const totalSeconds = (session.minutes || 0) * 60;
      const activeData = {
        id,
        name: session.name || "Session",
        minutes: session.minutes || 0,
        state: "running",
        totalSeconds,
        remainingSeconds: totalSeconds,
        startedAt: Date.now()
      };

      await activeSessionRef.set(activeData);
      await sessionsRef.child(id).update({ state: "active" });
      slider.disabled = false;
      controllerStateEl.textContent = "Running";
      pulseRef.set(Number(slider.value));
    });

    async function endSession() {
      if (!active) return;
      controllerStateEl.textContent = "Finished";
      slider.disabled = true;
      pulseRef.set(0);

      const id = active.id;
      lockedSessionIds.add(id);

      // حذف بيانات الجلسة ومنع إعادة التشغيل [web:2][web:27]
      await sessionsRef.child(id).remove();
      await activeSessionRef.set(null);

      active = null;
      updateCountdownText(0);
      sessionInfoEl.textContent = "Session finished";
    }

    stopBtn.addEventListener("click", () => {
      endSession();
    });
  </script>
</body>
</html>
