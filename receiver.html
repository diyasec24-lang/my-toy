<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pulse Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
    body {
      background: radial-gradient(circle at top,#1f2933,#020617);
      color:#e5e7eb;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .app {
      width:100%;
      max-width:420px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      padding:20px 18px 18px;
      box-shadow:0 18px 45px rgba(0,0,0,0.65);
      border:1px solid rgba(148,163,184,0.25);
    }
    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:14px;
    }
    .title { font-size:1.1rem; font-weight:600; letter-spacing:.04em; }
    .status-pill {
      font-size:0.75rem;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(34,197,94,0.12);
      color:#4ade80;
      border:1px solid rgba(74,222,128,0.4);
    }
    .id-badge {
      font-size:0.78rem;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(236,72,153,0.15);
      border:1px solid rgba(236,72,153,0.8);
      color:#f9a8d4;
      margin-left:6px;
    }

    .card {
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(15,23,42,0.9);
      margin-bottom:10px;
    }
    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:#9ca3af;
      margin-bottom:8px;
    }

    #waveCanvas {
      width:100%;
      height:140px;
      border-radius:12px;
      background:#020617;
      border:1px solid rgba(30,64,175,0.6);
    }

    .session-row {
      display:flex;
      justify-content:space-between;
      font-size:0.8rem;
      margin-top:8px;
      color:#9ca3af;
    }
    .session-row strong { color:#e5e7eb; }

    .form-row {
      display:flex;
      gap:8px;
      margin-top:8px;
    }
    input, button {
      border-radius:999px;
      border:1px solid rgba(75,85,99,0.9);
      background:rgba(15,23,42,0.9);
      color:#f9fafb;
      font-size:0.8rem;
      padding:7px 10px;
    }
    input:focus, button:focus {
      outline:none;
      border-color:#22c55e;
      box-shadow:0 0 0 1px rgba(34,197,94,0.35);
    }
    input[type="number"] { width:100%; }
    button {
      cursor:pointer;
      border:none;
      white-space:nowrap;
    }
    .primary-btn {
      background:linear-gradient(135deg,#22c55e,#16a34a);
      border:none;
      font-weight:500;
      color:#ecfdf5;
    }
    .hint { font-size:0.72rem; color:#6b7280; margin-top:4px; }
  </style>

  <!-- Firebase compat SDK [web:1][web:20] -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">
        Lush Pulse • Receiver
        <span id="currentSessionId" class="id-badge" style="display:none;"></span>
      </div>
      <div class="status-pill" id="connectionStatus">LIVE</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Live Pulse Curve</span>
        <span id="sessionLabel">No active session</span>
      </div>
      <canvas id="waveCanvas"></canvas>
      <div class="session-row">
        <span>Pulse Level: <strong id="pulseText">0</strong>/10</span>
        <span>Remaining: <strong id="remainingText">00:00</strong></span>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Create Session</span>
        <span id="createdIdLabel"></span>
      </div>
      <div class="form-row">
        <input id="sessionName" type="text" placeholder="Session name (optional)" />
        <input id="sessionMinutes" type="number" min="1" max="180" placeholder="Minutes" />
        <button id="createBtn" class="primary-btn">Create</button>
      </div>
      <div class="hint">
        A unique ID will be generated. Share it with the controller to start the session.
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCSQRo8ee2Dj26J0PQyQsosLfkNDw4Lni0",
      authDomain: "testapp-9b43c.firebaseapp.com",
      databaseURL: "https://testapp-9b43c-default-rtdb.firebaseio.com",
      projectId: "testapp-9b43c",
      storageBucket: "testapp-9b43c.firebasestorage.app",
      messagingSenderId: "475089690708",
      appId: "1:475089690708:web:f86d7436dfa74a96134dc1",
      measurementId: "G-FZCZQGZD5Y"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const pulseRef         = db.ref("device/pulseLevel");
    const activeSessionRef = db.ref("device/activeSession");
    const sessionsRef      = db.ref("sessions");

    const connectionStatusEl = document.getElementById("connectionStatus");
    const sessionLabelEl     = document.getElementById("sessionLabel");
    const pulseTextEl        = document.getElementById("pulseText");
    const remainingTextEl    = document.getElementById("remainingText");
    const currentSessionIdEl = document.getElementById("currentSessionId");
    const createdIdLabelEl   = document.getElementById("createdIdLabel");
    const sessionNameInput   = document.getElementById("sessionName");
    const sessionMinutesInput= document.getElementById("sessionMinutes");
    const createBtn          = document.getElementById("createBtn");

    const canvas = document.getElementById("waveCanvas");
    const ctx    = canvas.getContext("2d");
    let lastPulseTs = Date.now();
    let pulseLevel  = 0;

    // مصفوفة تاريخ القيم لتكوين المنحنى [web:114][web:121]
    const history = [];
    const MAX_POINTS = 60;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      canvas.width  = rect.width * window.devicePixelRatio;
      canvas.height = rect.height * window.devicePixelRatio;
      ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function valueToY(value, h) {
      const margin = 20;
      const usableHeight = h - margin * 2;
      const ratio = value / 10;
      return margin + usableHeight * ratio;
    }

    // رسم منحنى من history مع نقطة في النهاية [web:114][web:125]
    function drawWave() {
      const w = canvas.width / window.devicePixelRatio;
      const h = canvas.height / window.devicePixelRatio;
      ctx.clearRect(0, 0, w, h);

      if (history.length > 0) {
        const startX = 10;
        const stepX = (w - 30) / Math.max(history.length - 1, 1);

        ctx.beginPath();
        history.forEach((val, index) => {
          const x = startX + stepX * index;
          const y = valueToY(val, h);
          if (index === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });

        ctx.strokeStyle = "#ec4899";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        ctx.stroke();

        const lastIndex = history.length - 1;
        const endX = startX + stepX * lastIndex;
        const endY = valueToY(history[lastIndex], h);

        ctx.beginPath();
        ctx.arc(endX, endY, 6, 0, Math.PI * 2);
        ctx.fillStyle = "#ec4899";
        ctx.shadowColor = "rgba(236,72,153,0.9)";
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.shadowBlur = 0;
      }

      requestAnimationFrame(drawWave);
    }
    requestAnimationFrame(drawWave);

    // تحديث History من Firebase [web:2][web:97]
    pulseRef.on("value", (snap) => {
      const val = snap.val() ?? 0;
      pulseLevel = Math.max(0, Math.min(10, Number(val)));
      pulseTextEl.textContent = pulseLevel.toFixed(0);
      lastPulseTs = Date.now();

      history.push(pulseLevel);
      if (history.length > MAX_POINTS) history.shift();
    });

    activeSessionRef.on("value", (snap) => {
      const data = snap.val();
      if (!data) {
        sessionLabelEl.textContent = "No active session";
        remainingTextEl.textContent = "00:00";
        currentSessionIdEl.style.display = "none";
        return;
      }
      sessionLabelEl.textContent = data.name ? `Active • ${data.name}` : "Active session";
      currentSessionIdEl.textContent = data.id;
      currentSessionIdEl.style.display = "inline-block";

      const r = Math.max(0, data.remainingSeconds ?? 0);
      const m = String(Math.floor(r / 60)).padStart(2, "0");
      const s = String(r % 60).padStart(2, "0");
      remainingTextEl.textContent = `${m}:${s}`;
    });

    createBtn.addEventListener("click", async () => {
      const name = sessionNameInput.value.trim() || "Session";
      const minutes = parseInt(sessionMinutesInput.value, 10);
      if (!minutes || minutes <= 0) {
        alert("Please enter a valid minutes value.");
        return;
      }

      try {
        const newRef = sessionsRef.push();
        const id = newRef.key;
        await newRef.set({
          id,
          name,
          minutes,
          state: "pending",
          createdAt: Date.now()
        });

        createdIdLabelEl.textContent = `ID: ${id}`;
        sessionNameInput.value = "";
        sessionMinutesInput.value = "";
      } catch (e) {
        console.error(e);
        alert("Error creating session. Check console.");
      }
    });

    setInterval(() => {
      const delta = Date.now() - lastPulseTs;
      if (delta > 6000) {
        connectionStatusEl.textContent = "OFFLINE";
        connectionStatusEl.style.background = "rgba(239,68,68,0.12)";
        connectionStatusEl.style.color = "#f87171";
        connectionStatusEl.style.borderColor = "rgba(248,113,113,0.5)";
      } else {
        connectionStatusEl.textContent = "LIVE";
        connectionStatusEl.style.background = "rgba(34,197,94,0.12)";
        connectionStatusEl.style.color = "#4ade80";
        connectionStatusEl.style.borderColor = "rgba(74,222,128,0.4)";
      }
    }, 3000);
  </script>
</body>
</html>
